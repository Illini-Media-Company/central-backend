{# 
    DI Socials Poster Dashboard Template
    
    Displays a table of social stories with their posting status across platforms
    (Instagram, Facebook, Reddit, X, Threads). Includes search functionality and pagination.
    
    Last modified by Aryaa Rathi on Feb 19, 2026
#}
{% extends 'base.html' %}

{% block title %}
    DI Socials Poster
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="/static/styles/styles_index.css">
    <link rel="stylesheet" href="/static/macros/form.css">
    <style>
        table {
            border-collapse: separate;
            border-spacing: 0 0.5rem;
            width: 100%;
            background-color: var(--main-bg-color);
            border-radius: var(--main-border-radius);
        }

        tr {
            border-radius: var(--main-border-radius);
        }

        tr:hover td {
            background-color: var(--main-extralight-color);
        }

        td {
            padding: 0.75rem 0.5rem;
            background-color: var(--main-bg-color);
        }

        td:first-child {
            border-top-left-radius: var(--main-border-radius);
            border-bottom-left-radius: var(--main-border-radius);
        }

        td:last-child {
            border-top-right-radius: var(--main-border-radius);
            border-bottom-right-radius: var(--main-border-radius);
        }

        th {
            padding: 0.75rem 0.5rem;
            white-space: nowrap;
            border-bottom: 1px solid var(--main-lt-gray-color);
            align-items: center;
        }
    </style>
{% endblock %}

{% import "macros/form.html" as form %}
{% import "macros/pagination.html" as pagination %}
{% include "partials/loading.html" %}
{% include "partials/text_alert.html" %}
{% include "partials/info_bar.html" %}

{% block content %}
<h1>DI Socials Posts</h1>

<p>
    Automatically checks for new stories every 30 minutes. Clicking the button below will manually run the check.
</p>
<button class="button-secondary" onclick="runListener()">
    Check for New Stories
</button>
<hr style="margin-bottom: 2rem;">

<section class="section-container" id="stories-container">
    <div class="section-header">
        <h2 style="margin-bottom: 0">Social Media Posting Status</h2>
    </div>

    <div style="display: flex; flex-direction: row; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
        <div style="display: flex; flex-direction: row; align-items: center;" id="querySearchBar">
            <i class="bi bi-search"></i>
            {{ form.text_input( 
                name="searchQuery",
                placeholder="Search...",
                class=""
            ) }}
        </div>
    </div>

    {% if not stories %}
    <div class="inner-container" style="align-items: center; text-align: center;" id="no-stories-message">
        <p style="margin-bottom: 0;">There are no social stories to display.</p>
    </div>
    {% else %}
    <div style="overflow-x: auto; max-width: 100%; border-radius: var(--main-border-radius); box-shadow: var(--input-box-shadow);">
        <table>
            <thead>
                <tr>
                    <th style="width: 23%; min-width: 8rem;">Story</th>
                    <th style="width: 12%;">Date Posted</th>
                    <th style="width: 13%;"><i class="bi bi-instagram"></i>&nbsp; Instagram</th>
                    <th style="width: 13%;"><i class="bi bi-facebook"></i>&nbsp; Facebook</th>
                    <th style="width: 13%;"><i class="bi bi-reddit"></i>&nbsp; Reddit</th>
                    <th style="width: 13%;"><i class="bi bi-twitter-x"></i>&nbsp; Twitter/X</th>
                    <th style="width: 13%;"><i class="bi bi-threads"></i>&nbsp; Threads</th>
                </tr>
            </thead>
            <tbody>
                {% for story in stories %}
                <tr>
                    <td>
                        <a href="{{ story.story_url }}" target="_blank">{{ story.story_name }}</a>
                    </td>
                    <td>
                        {% if story.story_posted_timestamp %}
                            {{ story.story_posted_timestamp|ap_datetime }}
                        {% else %}
                            Not available
                        {% endif %}
                    </td>
                    <td>
                        {% if story.instagram_timestamp %}
                            <i class="bi bi-check-circle" style="color: var(--green-500); font-size: 0.75rem;"></i>&nbsp; {{ story.instagram_timestamp|ap_datetime }}
                        {% else %}
                            Not posted
                        {% endif %}
                    </td>
                    <td>
                        {% if story.facebook_timestamp %}
                            <i class="bi bi-check-circle" style="color: var(--green-500); font-size: 0.75rem;"></i>&nbsp; {{ story.facebook_timestamp|ap_datetime }}
                        {% else %}
                            Not posted
                        {% endif %}
                    </td>
                    <td>
                        {% if story.reddit_timestamp %}
                            <i class="bi bi-check-circle" style="color: var(--green-500); font-size: 0.75rem;"></i>&nbsp; {{ story.reddit_timestamp|ap_datetime }}
                        {% else %}
                            Not posted
                        {% endif %}
                    </td>
                    <td>
                        {% if story.x_timestamp %}
                            <i class="bi bi-check-circle" style="color: var(--green-500); font-size: 0.75rem;"></i>&nbsp; {{ story.x_timestamp|ap_datetime }}
                        {% else %}
                            Not posted
                        {% endif %}
                    </td>
                    <td>
                        {% if story.threads_timestamp %}
                            <i class="bi bi-check-circle" style="color: var(--green-500); font-size: 0.75rem;"></i>&nbsp; {{ story.threads_timestamp|ap_datetime }}
                        {% else %}
                            Not posted
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {{ pagination.pagination(page, total_stories, per_page, "page") }}
    {% endif %}
</section>

<script>
    window.addEventListener('load', () => {
        const msg = sessionStorage.getItem("infoBarMessage");
        if (msg) {
            showInfoBar(msg);
            sessionStorage.removeItem("infoBarMessage"); // Clear it after showing
        }

        // Event listener to handle search query input
        const searchInput = document.getElementById("searchQuery");
        const table = document.querySelector("table");
        
        if (searchInput && table) {
            const tbody = table.querySelector("tbody");
            
            searchInput.addEventListener("input", () => {
                const query = searchInput.value.toLowerCase().trim();

                Array.from(tbody.querySelectorAll("tr")).forEach(row => {
                    const text = row.innerText.toLowerCase();
                    row.style.display = text.includes(query) ? "" : "none";
                });
            });
        }
    });

    async function runListener() {
        console.log("Running...");

        showLoading("Running...");

        // Send the data to the backend endpoint
        let endpoint = "/cron/socials-rss-listener";
        const payload = {
            _csrf_token: "{{ csrf_token() }}",
        }

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
        });

        // Check if it was successful
        if (response.status === 200) {
            // Trigger a reload of the window
            sessionStorage.setItem("infoBarMessage", `Successfully checked for stories.`); // Save so we can display after reload
            window.location.reload();
        } else {
            // Alert of the error
            console.log("Checking for stories failed!");

            try {
                const data = await response.json();
                const message = data.error || "An unknown error occurred.";

                console.error(message);
                hideLoading();
                await showTextAlert(header="There was an error:", body=message, buttonText="Dismiss");
            } catch (err) {
                const fallback = await response.text();
                hideLoading();
                await showTextAlert(header="Fatal Error:", body=fallback, buttonText="Dismiss");
            }
        }
    }
</script>

{% endblock %}

