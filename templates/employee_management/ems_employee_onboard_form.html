{% extends 'employee_management/ems_base.html' %}

{% block ems_title %}
    Onboarding Form
{% endblock %}

{% block ems_extra_head %}
    <link rel="stylesheet" href="/static/macros/form.css">

    <style>
        .ems-nav-container {
            display: none;
        }

        .onboarding-form {
            gap: 0.5rem;
        }

        .onboarding-form-row {
            flex-direction: column;
            align-items: flex-start;
            flex: 1 1 10rem;
        }

        .form-row-shrink {
            flex: 0 1 auto;
        }

        .narrow-row {
            flex: 1 1 4rem;
        }

        .row-vertical-flex {
            flex: 1;
        }

        .column-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex-wrap: wrap;
            flex: 1 1 20rem;
        }
    </style>
{% endblock %}

{% import "macros/form.html" as form %}
{% include "partials/loading.html" %}
{% include "partials/text_alert.html" %}
{% include "partials/info_bar.html" %}

{% block ems_content %}
<div style="display: flex; flex-direction: row; gap: 2rem; align-items: center;">
    <h2>Complete Your Onboarding</h2>
</div>

<p>
    Please complete the following form. Ensure all information is accurate. 
    Once you submit, your supervisor will have to make any modifications. 
    Please reach out to 
    <span><a href="mailto:helpdesk@illinimedia.com">helpdesk@illinimedia.com</a></span> 
    with any questions or issues.
</p>
<p>
    If you have previously worked for Illini Media Company at any time, 
    <span style="font-weight: 500;">do not fill out this form</span> and email 
    <span><a href="mailto:helpdesk@illinimedia.com">helpdesk@illinimedia.com</a></span>.
</p>

<hr>

<section class="section-container">
    {% call form.form(id="employeeOnboardingForm", class="onboarding-form", enctype="application/x-www-form-urlencoded", on_submit="submitOnboarding(event)") %}
    
        <div style="display: flex; flex-direction: row; gap: 0.5rem; flex-wrap: wrap; align-items: flex-start;">
            {# Left column #}
            <div class="column-container">
                {# Contact Information #}
                <div class="inner-container" style="padding: 0.75rem;">
                    <div class="section-header">
                        <h3 style="margin-bottom: 0">Contact Information</h3>
                    </div>
                    <hr style="margin-top: 1rem;">

                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: flex; flex-direction: row; gap: 1rem; flex-wrap: wrap;">
                            {{ form.text_input( 
                                name="last_name",
                                label="Last Name",
                                required=true,
                                initial_val=employee_first_name,
                                class="onboarding-form-row"
                            ) }}
                            {{ form.text_input( 
                                name="first_name",
                                label="First Name",
                                required=true,
                                initial_val=employee_last_name,
                                class="onboarding-form-row"
                            ) }}
                            {{ form.select_input( 
                                name="pronouns",
                                label="Pronouns",
                                options=pronoun_options,
                                required=true,
                                class="onboarding-form-row form-row-shrink"
                            ) }}
                        </div>

                        <div style="display: flex; flex-direction: row; gap: 1rem; flex-wrap: wrap;">
                            {{ form.text_input( 
                                name="personal_email",
                                label="Personal Email Address",
                                subtext="Should not be @illinois.edu",
                                pattern="^(?!.*@illinois\.edu$).*$",
                                required=true,
                                alt_type="email",
                                class="onboarding-form-row"
                            ) }}

                            {{ form.text_input( 
                                name="phone_number",
                                label="Personal Phone Number",
                                placeholder="+# (###) ### - ####",
                                required=true,
                                alt_type="tel",
                                pattern="^(\+\d{1,3}\s)?\(\d{3}\)\s\d{3}\s-\s\d{4}$",
                                class="onboarding-form-row row-vertical-flex"
                            ) }}
                        </div>
                    </div>
                </div>

                {# Address #}
                <div class="inner-container" style="padding: 0.75rem;">
                    <div class="section-header">
                        <div>
                            <h3 style="margin-bottom: 0">Permanent Address</h3>
                            <p style="margin-bottom: 0; margin-top: 0.5rem;">This should be your permanent home address, not your campus address, unless your permanent address is not in the United States.</p>
                        </div>
                    </div>
                    <hr style="margin-top: 1rem;">

                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: flex; flex-direction: row; gap: 1rem; flex-wrap: wrap;">
                            {{ form.text_input( 
                                name="permanent_address_1",
                                label="Address Line 1",
                                subtext="Street address",
                                required=true,
                                class="onboarding-form-row"
                            ) }}

                            {{ form.text_input( 
                                name="permanent_address_2",
                                label="Address Line 2",
                                subtext="Apartment, suite, unit, etc.",
                                required=false,
                                class="onboarding-form-row"
                            ) }}
                        </div>
                        
                        <div style="display: flex; flex-direction: row; gap: 1rem; flex-wrap: wrap;">
                            {{ form.text_input( 
                                name="permanent_city",
                                label="City",
                                required=true,
                                class="onboarding-form-row"
                            ) }}

                            {{ form.text_input( 
                                name="permanent_state",
                                label="State",
                                maxlength=2,
                                required=true,
                                class="onboarding-form-row"
                            ) }}

                            {{ form.text_input( 
                                name="permanent_zip",
                                label="ZIP Code",
                                pattern="[0-9]{5}",
                                maxlength=5,
                                required=true,
                                class="onboarding-form-row"
                            ) }}
                        </div>
                    </div>
                </div>
            </div>

            {# Right column #}
            <div class="column-container">
                {# Academics #}
                <div class="inner-container" style="padding: 0.75rem;">
                    <div class="section-header">
                        <div>
                            <h3 style="margin-bottom: 0">Academics</h3>
                            <p style="margin-bottom: 0; margin-top: 0.5rem;">
                                Use the full and correct name of the program (i.e. "Molecular & Cellular Biology" instead of "MCB").
                                You <span style="font-weight: 500;">may</span> leave fields blank. Do not type "N/A", "None" or anything similar if a field does not apply to you.
                            </p>
                        </div>
                    </div>
                    <hr style="margin-top: 1rem;">
                    
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        {# Major(s) #}
                        <div style="display: flex; flex-direction: row; gap: 1rem; flex-wrap: wrap;">
                            {{ form.text_input( 
                                name="major",
                                label="Major",
                                required=true,
                                class="onboarding-form-row"
                            ) }}
                            {{ form.text_input( 
                                name="major_2",
                                label="Major 2 (Optional)",
                                required=false,
                                class="onboarding-form-row"
                            ) }}
                            {{ form.text_input( 
                                name="major_3",
                                label="Major 3 (Optional)",
                                required=false,
                                class="onboarding-form-row"
                            ) }}
                        </div>

                        {# Minor(s) #}
                        <div style="display: flex; flex-direction: row; gap: 1rem; flex-wrap: wrap;">
                            {{ form.text_input( 
                                name="minor",
                                label="Minor (Optional)",
                                required=false,
                                class="onboarding-form-row"
                            ) }}
                            {{ form.text_input( 
                                name="minor_2",
                                label="Minor 2 (Optional)",
                                required=false,
                                class="onboarding-form-row"
                            ) }}
                            {{ form.text_input( 
                                name="minor_3",
                                label="Minor 3 (Optional)",
                                required=false,
                                class="onboarding-form-row"
                            ) }}
                        </div>

                        {# Grad Year #}
                        <div style="display: flex; flex-direction: row; gap: 1rem; flex-wrap: wrap;">
                            {{ form.select_input( 
                                name="graduation",
                                label="Expected Graduation Term",
                                options=grad_year_options,
                                required=true,
                                class="onboarding-form-row"
                            ) }}
                        </div>
                    </div>
                </div>

                {# Other #}
                <div class="inner-container" style="padding: 0.75rem;">
                    <div class="section-header">
                        <h3 style="margin-bottom: 0">Other</h3>
                    </div>
                    <hr style="margin-top: 1rem;">

                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: flex; flex-direction: row; gap: 1rem; flex-wrap: wrap;">
                            {{ form.text_input( 
                                name="netid",
                                label="University NetID (part before @illinois.edu)",
                                required=true,
                                class="onboarding-form-row narrow-row"
                            ) }}
                            {{ form.text_input( 
                                name="birth_date",
                                label="Date of Birth",
                                alt_type="date",
                                required=true,
                                class="onboarding-form-row narrow-row"
                            ) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="text-align: center;">
            {{ form.submit_button(text="Submit", label="submit_button") }}
        </div>
    
    {% endcall %}
</section>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const msg = sessionStorage.getItem("infoBarMessage");
        if (msg) {
            showInfoBar(msg);
            sessionStorage.removeItem("infoBarMessage");
        }
    });

    window.addEventListener('load', () => {
        // Handles formatting for the employee's phone number
        document.getElementById('phone_number').addEventListener('input', function (e) {
            let input = e.target.value;
            let hasPlus = input.startsWith('+');
            
            // Strip all non-digits
            let digits = input.replace(/\D/g, '');
            
            let formatted = "";

            if (hasPlus && digits.length > 10) {
                let countryCode = digits.substring(0, digits.length - 10);
                let localPart = digits.substring(digits.length - 10);
                
                let match = localPart.match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
                formatted = '+' + countryCode + ' (' + match[1] + ') ' + (match[2] ? match[2] : '') + (match[3] ? ' - ' + match[3] : '');
            } else {
                // Fallback to standard US formatting if no plus or short number
                let match = digits.match(/(\d{0,3})(\d{0,3})(\d{0,4})/);
                if (!match[2]) {
                    formatted = match[1];
                } else {
                    formatted = '(' + match[1] + ') ' + match[2] + (match[3] ? ' - ' + match[3] : '');
                }

                if (hasPlus) formatted = '+' + formatted;
            }

            e.target.value = formatted.trim();
        });
    });

    async function submitOnboarding(event) {
        event.preventDefault();
        console.log("Submitting...");

        showLoading("Creating Employee...");

        const formData = new FormData(event.target);

        // Send the data to the backend endpoint
        let endpoint = "/ems/api/onboarding/{{ employee.uid }}/submit";
        const payload = {
            _csrf_token: "{{ csrf_token() }}",
            ...Object.fromEntries(
                Array.from(formData.entries()).filter(([key, value]) => value !== "")
            ),
        }

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
        });

        // Check if it was successful
        if (response.status === 200) {
            // Trigger a reload of the window
            sessionStorage.setItem("infoBarMessage", "Employee successfully updated."); // Safe so we can display after reload
            window.location.href = "{{ redirect_url }}";
        } else {
            // Alert of the error
            console.log("Updating the employee failed!");

            try {
                const data = await response.json();
                const message = data.error || "An unknown error occurred.";

                console.error(message);
                hideLoading();
                await showTextAlert(header="There was an error:", body=message, buttonText="Dismiss");
            } catch (err) {
                const fallback = await response.text();
                hideLoading();
                await showTextAlert(header="Fatal Error:", body=fallback, buttonText="Dismiss");
            }
        }
    }
</script>

{% endblock %}
