{% extends 'base.html' %} {% block title %}Home{% endblock %} {% block
extra_head %}
<link rel="stylesheet" href="/static/styles/styles_index.css" />
<link rel="stylesheet" href="/static/styles/styles_forms_dashboard.css" />
<!-- Includes from your setup -->
{% include "partials/loading.html" %} {% include "partials/info_bar.html" %} {%
endblock %} {% block content %}
<h2>Pending Documents</h2>

<ul class="doc-list" id="docList"></ul>

<div class="modal" id="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 id="modalTitle"></h3>
    <p id="modalText"></p>

    <div id="signature" class="signature"></div>
    <button id="signBtn" class="sign-btn">Sign</button>
    <button id="sendBtn" class="send-btn" disabled>Send</button>
  </div>
</div>

<script>
  const docList = document.getElementById("docList");
  const modal = document.getElementById("modal");
  const modalTitle = document.getElementById("modalTitle");
  const modalText = document.getElementById("modalText");
  const signBtn = document.getElementById("signBtn");
  const sendBtn = document.getElementById("sendBtn");
  const signature = document.getElementById("signature");
  const closeModal = document.querySelector(".close");

  let pendingDocs = [];
  let currentDoc = null;

  // Fetch pending agreements from backend
  async function fetchPendingDocs() {
    try {
      const response = await fetch(
        "/employee-agreement/get-pending-signatures"
      );
      if (!response.ok) throw new Error("Failed to fetch pending agreements");
      const data = await response.json();
      pendingDocs = data.pending_agreements || [];
      renderDocs();
    } catch (err) {
      console.error(err);
      docList.innerHTML = "<p>Failed to load pending agreements.</p>";
    }
  }

  // Render pending agreements
  function renderDocs() {
    docList.innerHTML = "";
    if (pendingDocs.length === 0) {
      docList.innerHTML = "<p>Nothing left to do :D</p>";
      return;
    }
    pendingDocs.forEach((doc) => {
      const li = document.createElement("li");
      li.classList.add("doc-item");
      li.dataset.userId = doc.user_id;
      li.dataset.agreementUrl = doc.agreement_url;
      li.textContent = "Agreement for: Daily Illini Onboarding ";
      docList.appendChild(li);
    });
  }

  // Open modal on click
  docList.addEventListener("click", (event) => {
    const item = event.target.closest(".doc-item");
    if (!item) return;
    currentDoc = item;
    modalTitle.textContent = "Pending Agreement";
    modalText.textContent = `URL: ${item.dataset.agreementUrl}`;
    signature.textContent = "";
    signBtn.disabled = false;
    sendBtn.disabled = true;
    modal.style.display = "flex";
  });

  closeModal.addEventListener("click", () => (modal.style.display = "none"));
  modal.addEventListener("click", (e) => {
    if (e.target === modal) modal.style.display = "none";
  });

  // Sign agreement
  signBtn.addEventListener("click", () => {
    signature.textContent = "Signed by you";
    signBtn.disabled = true;
    sendBtn.disabled = false;
  });

  // Send signed agreement
  sendBtn.addEventListener("click", async () => {
    if (!currentDoc) return;

    const agreementUserId = currentDoc.dataset.userId;

    try {
      const response = await fetch("/employee-agreement/sign-agreement", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token() }}",
        },
        body: JSON.stringify({ agreement_user_id: agreementUserId }),
      });
      if (!response.ok) throw new Error("Failed to sign agreement");
      // Remove signed doc from the list
      currentDoc.remove();
      modal.style.display = "none";

      if (docList.children.length === 0) {
        docList.innerHTML = "<p>Nothing left to do :D</p>";
      }
    } catch (err) {
      console.error(err);
      alert("Failed to sign agreement");
    }
  });

  fetchPendingDocs();
</script>
{% endblock %}
