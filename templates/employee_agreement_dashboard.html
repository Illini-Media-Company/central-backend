{% extends 'base.html' %} 

{% block title %}
Employee Agreements
{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="/static/styles/styles_index.css" />
    <link rel="stylesheet" href="/static/styles/styles_employee-agreement-dashboard.css"/>
{%endblock %} 

{% include "partials/loading.html" %} 
{% include "partials/info_bar.html" %}
{% include "partials/text_alert.html" %}

{% block content %}
<h1>Employee Agreements Portal</h1>

<hr>

<section class="section-container">
    <div class="section-header">
        <h2 style="margin-bottom: 0">Agreements Pending Signature</h2>
    </div>
    <hr style="margin-top: 1rem;">
    <ul class="doc-list" id="docList">
        {% if agreements %}
        {% for agreement in agreements %}
        <li class="doc-item" data-agreement-id="{{ agreement.uid }}" data-agreement-url="{{ agreement.agreement_url }}">
            <h4 style="margin-bottom: 0;">{{ agreement.agreement_name }}</h4>
            <p style="margin-bottom: 0;">{{ agreement.user_email|to_user_name }}</p>
            <p style="margin-bottom: 0;">Created on {{ agreement.create_time|ap_datetime }}</p>
            <p style="margin-bottom: 0; font-size: 0.75rem;">
                {% if agreement.user_signed %}
                Signed by 
                {% if agreement.user_email|to_user_name %}
                    {{ agreement.user_email|to_user_name }} 
                {% else %}
                    employee
                {% endif %}
                on {{ agreement.user_signed|ap_datetime }}
                {% endif %} 
            </p>
            <p style="margin-bottom: 0; font-size: 0.75rem;">
                {% if agreement.editor_signed %}
                Signed by 
                {% if agreement.editor_email|to_user_name %}
                    {{ agreement.editor_email|to_user_name }} 
                {% else %}
                    editor
                {% endif %}
                on {{ agreement.editor_signed|ap_datetime }}
                {% endif %} 
            </p>
            <p style="margin-bottom: 0; font-size: 0.75rem;">
                {% if agreement.manager_signed %}
                Signed by 
                {% if agreement.manager_email|to_user_name %}
                    {{ agreement.manager_email|to_user_name }} 
                {% else %}
                    manager
                {% endif %}
                on {{ agreement.manager_signed|ap_datetime }}
                {% endif %} 
            </p>
        </li>
        {% endfor %}
        {% else %}
        <div class="inner-container" style="padding: 0.75rem; align-items: center; text-align: center;">
            <p style="margin-bottom: 0;">You do not currently have any agreements pending signature.</p>
        </div>
        {% endif %}
    </ul>
</section>

<hr>

<section class="section-container">
    <div class="section-header">
        <h2 style="margin-bottom: 0">Your Previous Agreements</h2>
    </div>
    <hr style="margin-top: 1rem;">
    {% if past_agreements %}
    {% for agreement in past_agreements %}
    <div class="inner-container" style="padding: 0.75rem;" id="{{ agreement.uid }}">
        <a href="{{ agreement.agreement_url }}" target="_blank"><h4 style="margin-bottom: 0.25rem;">{{ agreement.agreement_name }}</h4></a>
        <p style="margin-bottom: 0;">Created on {{ agreement.create_time|ap_datetime }}</p>
        <p style="margin-bottom: 0; font-size: 0.75rem;">
            {% if agreement.user_signed %}
            Signed by 
            {% if agreement.user_email|to_user_name %}
                {{ agreement.user_email|to_user_name }} 
            {% else %}
                employee
            {% endif %}
            on {{ agreement.user_signed|ap_datetime }}
            {% endif %} 
        </p>
        <p style="margin-bottom: 0; font-size: 0.75rem;">
            {% if agreement.editor_signed %}
            Signed by 
            {% if agreement.editor_email|to_user_name %}
                {{ agreement.editor_email|to_user_name }} 
            {% else %}
                editor
            {% endif %}
            on {{ agreement.editor_signed|ap_datetime }}
            {% endif %} 
        </p>
        <p style="margin-bottom: 0; font-size: 0.75rem;">
            {% if agreement.manager_signed %}
            Signed by 
            {% if agreement.manager_email|to_user_name %}
                {{ agreement.manager_email|to_user_name }} 
            {% else %}
                manager
            {% endif %}
            on {{ agreement.manager_signed|ap_datetime }}
            {% endif %} 
        </p>
        <p style="margin-bottom: 0; font-size: 0.75rem;">
            {% if agreement.chief_signed %}
            Signed by 
            {% if agreement.chief_email|to_user_name %}
                {{ agreement.chief_email|to_user_name }} 
            {% else %}
                Editor-in-Chief
            {% endif %}
            on {{ agreement.chief_signed|ap_datetime }}
            {% endif %} 
        </p>
    </div>
    {% endfor %}
    {% else %}
    <div class="inner-container" style="padding: 0.75rem; align-items: center; text-align: center;">
        <p style="margin-bottom: 0;">You do not currently have any previous agreements.</p>
    </div>
    {% endif %}
</section>



<div class="modal" id="modal">
    <div class="modal-content">
        <span class="close"><i class="bi bi-x-lg"></i></span>
        <h3 id="modalTitle"></h3>
        <p id="modalText"></p>

        <div id="signature" class="signature"></div>
        <div
            style="
              display: flex;
              flex-direction: row;
              gap: 0.5rem;
              justify-content: center;
            "
        >
            <button id="signBtn" class="button-primary">Sign</button>
            <button id="sendBtn" class="button-secondary" disabled>Complete</button>
        </div>
    </div>
</div>

<script>
    const docList = document.getElementById("docList");
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const modalText = document.getElementById("modalText");
    const signBtn = document.getElementById("signBtn");
    const sendBtn = document.getElementById("sendBtn");
    const signature = document.getElementById("signature");
    const closeModal = document.querySelector(".close");

    let pendingDocs = [];
    let currentDoc = null;

    // Show the confirmation info bar after the page reloads
    document.addEventListener("DOMContentLoaded", () => {
        const msg = sessionStorage.getItem("infoBarMessage");
        if (msg) {
            showInfoBar(msg);
            sessionStorage.removeItem("infoBarMessage"); // Clear it after showing
        }
    });

    // Open modal on click
    docList.addEventListener("click", (event) => {
        const item = event.target.closest(".doc-item");
        if (!item) return;
        currentDoc = item;
        modalTitle.textContent = "Pending Agreement";
        modalText.innerHTML = `Agreement URL: <a href="${item.dataset.agreementUrl}" target="_blank">Open Agreement</a>`;
        signature.textContent = "";
        signBtn.disabled = false;
        sendBtn.disabled = true;
        modal.style.display = "flex";
    });

    closeModal.addEventListener("click", () => (modal.style.display = "none"));
    modal.addEventListener("click", (e) => {
        if (e.target === modal) modal.style.display = "none";
    });

    signBtn.addEventListener("click", () => {
        signature.textContent = "{{ currentUserName }}";
        signBtn.disabled = true;
        sendBtn.disabled = false;
    });

    // Send signed agreement
    sendBtn.addEventListener("click", async () => {
        if (!currentDoc) return;

        showLoading("Sending...");

        const uid = currentDoc.dataset.agreementId;

        let endpoint = "/employee-agreement/" + uid + "/sign";

        const response = await fetch(endpoint, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token() }}",
            },
        });

        if (response.status === 200) {
            // Trigger a reload of the window
            sessionStorage.setItem("infoBarMessage", "Agreement successfully signed."); // Safe so we can display after reload
            window.location.reload();
        } else {
            // Alert of the error and re-enable the submit button
            console.log("Failed to sign agreement.");
            const message = await response.text();
            console.error(message);
            await showTextAlert(
                header = "There was an error:",
                body = message,
                buttonText = "Dismiss",
            );
            hideLoading();
        }
    });
</script>em
{% endblock %}
