{% extends 'base.html' %}

{% block title %}
Breaking
{% endblock %}

{% block content %}
<style>
    .container {
        width: 80%;
        margin-bottom: 10px;
    }
    .form-control, .form-select {
        border-color: #a8a8a8;
    }
</style>

<div class="container">
    <form action="/breaking/submit" method="post" enctype="application/x-www-form-urlencoded">
        <div class="row my-4">
            <label for="url" class="col-sm-1 col-form-label">Story URL</label>
            <div class="col-sm-11">
                <input type="text" id="url" class="form-control" name="url">
            </div>
        </div>
    
        <div class="row my-4">
            <div class="col-sm-1">
                <label for="post_to" class="col-form-label">Publish to:</label>
            </div>
            
            <div class="col-sm-2">
                <div id="post_to" class="form-check">
                    <input type="checkbox" id="redditCheckbox" class="form-check-input" name="post_to_reddit" value="1">
                    <label class="form-check-label" for="redditCheckbox">Reddit</label>
                </div>
            
                <div id="post_to" class="form-check">
                    <input type="checkbox" id="twitterCheckbox" class="form-check-input" name="post_to_twitter" value="1">
                    <label class="form-check-label" for="twitterCheckbox">Twitter</label>
                </div>
            </div>
            
            <div class="col-sm-2">
                <button type="submit" class="btn btn-primary" onclick="submitForm(this)">Submit</button>
            </div>
        </div>
    </form>
</div>


<div class="container d-flex justify-content-between align-items-center">
    <h3>Recent Stories</h3>
</div>

<div class="container">
    <table class="table table-bordered">
        <tr>
            <th>Title</th>
            <th>Date Submitted</th>
            <th>Date Published</th>
            <th>Social Media Platforms</th>
        </tr>
        {% for story in stories %}
        <tr>
            <td>{{ story.title }}</td>
            <td>{{ story.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            <td>
                {% if story.published_at %}
                {{ story.published_at.strftime('%Y-%m-%d %H:%M:%S') }}
                {% else %}
                Not published
                {% endif %}
            </td>
            <td>
                {% if story.post_to_reddit %}
                Reddit
                {% endif %}
                {% if story.post_to_twitter %}
                Twitter
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
</div>


<script>
    const endpoint = "/breaking/submit";

    async function submitForm(button) {
        button.disabled = true;
        button.innerHTML = 'Submitting...';

        const url = document.getElementById('url').value;
        const post_to_reddit = document.getElementById('redditCheckbox').checked ? '1' : '0';
        const post_to_twitter = document.getElementById('twitterCheckbox').checked ? '1' : '0';

        const formData = new URLSearchParams();
        formData.append('url', url);
        formData.append('post_to_reddit', post_to_reddit);
        formData.append('post_to_twitter', post_to_twitter);
        formData.append('_csrf_token', '{{ csrf_token() }}');

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData.toString(),
        });

        if (response.status === 200) {
            window.location.reload();
        } else {
            const message = await response.text();
            console.error(message);
            alert(message);

            button.disabled = false;
            button.innerHTML = 'Submit';
        }
    }
</script>
{% endblock %}

