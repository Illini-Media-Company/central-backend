{% extends 'base.html' %} {% block title %}Employee Agreement Portal{% endblock
%} {% block extra_head %}
<link rel="stylesheet" href="/static/styles/styles_index.css" />
<link rel="stylesheet" href="/static/DI_Contract_Automization.css" />
{% include "partials/loading.html" %} {% include "partials/info_bar.html" %} {%
endblock %} {% block content %}
<header>
  <h1>Employee Agreement Portal</h1>
  <p class="subtitle">Send and track employee contracts in one place.</p>

  <div class="dashboard-btn-container">
    <button
      class="dashboard-btn"
      onclick="window.location.href='/onboarding/dashboard'"
    >
      Go to Dashboard
    </button>
  </div>
</header>

<main class="di-contract-main">
  <!-- Left Side of the Admin Page -->
  <section class="left">
    <h2>Send Agreement Form</h2>
    <p class="note">Enter employee and signer details to begin.</p>
    <div class="form-group">
      <label for="employee-emails">New Employee Emails</label>
      <textarea
        id="employee-emails"
        placeholder="Enter one email per line&#10;e.g. jdoe@illinimedia.com&#10;asmith@illinimedia.com"
      ></textarea>
      <p class="hint">
        Tip: Paste multiple emails — one per line. All must end with
        @illinimedia.com
      </p>
    </div>

    <div class="form-group">
      <label for="editor-email">Editor Email</label>
      <input
        type="email"
        id="editor-email"
        placeholder="e.g. editor@illinimedia.com"
        pattern="^[^@\\s]+@illinimedia\\.com$"
        title="Email must end with @illinimedia.com"
        required
      />
    </div>

    <div class="form-group">
      <label for="manager-email">Manager Email</label>
      <input
        type="email"
        id="manager-email"
        placeholder="e.g. manager@illinimedia.com"
        pattern="^[^@\\s]+@illinimedia\\.com$"
        title="Email must end with @illinimedia.com"
        required
      />
    </div>

    <div class="form-group">
      <label for="chief-email">Chief Email</label>
      <input
        type="email"
        id="chief-email"
        placeholder="e.g. chief@illinimedia.com"
        pattern="^[^@\\s]+@illinimedia\\.com$"
        title="Email must end with @illinimedia.com"
        required
      />
    </div>

    <button id="send-btn">Send Agreements</button>
  </section>

  <!-- RIGHT SIDE: Pending Contracts That the current manager needs to sign -->
  <section class="right">
    <h2>Pending Contracts</h2>
    <div class="doc-box" id="pendingContracts">
      <p class="loading-text">Loading pending contracts...</p>
    </div>
  </section>

  <!-- SCRIPT BLOCK -->
  <script>
    // ===== LEFT SIDE: SEND AGREEMENTS =====
    document.getElementById("send-btn").addEventListener("click", async () => {
      const emailsText = document
        .getElementById("employee-emails")
        .value.trim();
      const editorEmail = document.getElementById("editor-email").value.trim();
      const managerEmail = document
        .getElementById("manager-email")
        .value.trim();
      const chiefEmail = document.getElementById("chief-email").value.trim();

      const emails = emailsText
        .split("\n")
        .map((e) => e.trim())
        .filter((e) => e);

      // Validate that all emails end with @illinimedia.com
      const invalidEmails = emails.filter(
        (e) => !e.endsWith("@illinimedia.com")
      );
      if (invalidEmails.length > 0) {
        alert(
          "The following emails are invalid:\n" +
            invalidEmails.join("\n") +
            "\n\nAll emails must end with @illinimedia.com"
        );
        return;
      }

      // Validate single-line email inputs
      const singleEmails = [editorEmail, managerEmail, chiefEmail];
      for (const e of singleEmails) {
        if (!e.endsWith("@illinimedia.com")) {
          alert("All signer emails must end with @illinimedia.com");
          return;
        }
      }

      if (emails.length === 0) {
        alert("Please enter at least one employee email.");
        return;
      }

      const payload = {
        emails: emails,
        editor: editorEmail,
        manager: managerEmail,
        chief: chiefEmail,
      };

      try {
        const response = await fetch("/employee-agreement/send-notification", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token() }}",
          },
          body: JSON.stringify(payload),
        });

        if (response.ok) {
          alert("Agreements successfully sent!");
        } else if (response.status === 500) {
          alert("Failed to send: Some names do not exist in Slack");
        } else {
          const errorText = await response.text();
          alert(`Failed to send: ${errorText}`);
        }
      } catch (error) {
        console.error("Fetch error:", error);
        alert("An error occurred while sending the agreements.");
      }
    });

    async function fetchPendingContracts() {
      const container = document.getElementById("pendingContracts");
      try {
        const response = await fetch(
          "/employee-agreement/get-pending-signatures"
        );
        if (!response.ok) throw new Error("Failed to load pending contracts.");
        const data = await response.json();
        const pending = data.pending_agreements || [];

        container.innerHTML = ""; // clear loading text

        if (pending.length === 0) {
          container.innerHTML =
            "<p class='no-docs'>No contracts need further action currently</p>";
          return;
        }

        // Display each pending contract
        pending.forEach((doc) => {
          const div = document.createElement("div");
          div.classList.add("doc-item");
          div.innerHTML = `
            <h3>Employee: ${doc.employee_name || "Unknown"}</h3>
            <p>Status: ${doc.status || "Pending"}</p>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        console.error(err);
        container.innerHTML =
          "<p class='error-text'>❌ Failed to load pending contracts.</p>";
      }
    }

    // Load pending contracts when page loads
    fetchPendingContracts();
  </script>
</main>
{% endblock %}
