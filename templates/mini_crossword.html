{% extends 'base.html' %}

{% block title %}
Mini Crossword Admin
{% endblock %}

{% block content %}
<style>
    .container {
        width: 80%;
        margin: 0 auto;
        margin-top: 25px;
    }
    .modifiable-input {
        display: none;
    }
    .modifiable-url-input {
        display: none;
    }
    .table th:nth-child(1),
    .table td:nth-child(1) {
        width: 12.5%; /* Set a fixed width for the Date column */
    }
    .table th:nth-child(2),
    .table td:nth-child(2) {
        width: 15%; /* Set a fixed width for the Word column */
    }
    .table th:nth-child(3),
    .table td:nth-child(3) {
        width: 10%; /* Set a fixed width for the Word column */
    }
    .table th:nth-child(4),
    .table td:nth-child(4) {
        width: 45%; /* Set a fixed width for the Related Story column */
    }
    .table th:nth-child(5),
    .table td:nth-child(5) {
        width: 17.5%; /* Set a fixed width for the Actions column */
    }
    .error-message {
        color: red;
    }

    .crossword-input {
        padding-bottom: 2vh;
        float: left;
        width: 50%;
    }
    .clues-input {
        float: left;
        width: 50%;
    }
    .crossword-row {
        padding: 0;
    }
    .letter {
        height: 10vh;
        width: 10vh;
        font-size: 9vh;
        padding: 0;
    }
    .letter-blacked-out {
        background-color: black;
    }
</style>

<div class="container">
    <div class="d-flex justify-content-center">
        <div class="w-100">
            <h3>Mini Crossword Dashboard</h3>
            <h2>Crossword Creation Instructions: </h2>
            <p>1. Double-click a square to black it out.</p>
            <p>2. Enter all letters before adding clues.</p>
            <form id="cw-form">
                <label for="crossword-date">Crossword Date:</label>
                <input type="date" id="crossword-date" name="crossword-date" required>
                <br><br>
                <label for="article-link">Related Article Link:</label>
                <input type="text" id="article-link" placeholder="https://dailyillini.com/..." required>
                <br><br>
                <div class="crossword-input">
                    {% for r in [0, 1, 2, 3, 4] %}
                    <div class="crossword-row" id="cross-row-{{r}}">
                        {% for c in [0, 1, 2, 3, 4] %}
                        <input type="text" class="letter" maxlength=1 id="cross-box-{{r}}-{{c}}">
                        {% endfor %}
                    </div>
                    {% endfor %}
                
                <input type="button" value="Add Clues" onclick=addClues()>
                </div>
                <div id="clues-input" class="clues-input">

                </div>
                <!-- <input type="submit" value="Add Clues"> -->
                <div id="save-msg" style="color:red; margin-top:12px; font-weight:bold;"></div>
            </form>
        </div>
    </div>
</div>
<script>
    //CSRF cookie reader
    function getCookie(name) {
        const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
        return m ? decodeURIComponent(m[1]) : null;
    }
    const CSRF = getCookie('_csrf_token');
    // set up toggling 
    for (let r = 0; r < 5; r++) {
        for (let c = 0; c < 5; c++) {
            let id = "cross-box-" + String(r) + "-" + String(c);
            document.getElementById(id).addEventListener('dblclick', function() {
                this.classList.toggle('letter-blacked-out');
                if (this.getAttribute("maxlength") == 0) {
                    this.setAttribute("maxlength", 1);
                } else {
                    this.setAttribute("maxlength", 0);
                }
            });
        }
    }

    function addClues() {
        const puzzle = [["-", "-", "-", "-", "-"], 
                      ["-", "-", "-", "-", "-"], 
                      ["-", "-", "-", "-", "-"], 
                      ["-", "-", "-", "-", "-"], 
                      ["-", "-", "-", "-", "-"]];
        for (let r = 0; r < 5; r++) {
            for (let c = 0; c < 5; c++) {
                let letter = document.getElementById("cross-box-" + String(r) + "-" + String(c));
                if (letter.value.length == 1) {
                    puzzle[r][c] = String(letter.value);
                }
            }
        }
        console.log(puzzle);

        const acrossClues = [];
        console.log(acrossClues);
        for (let r = 0; r < 5; r++) {
            let word = "";
            for (let c = 0; c < 5; c++) {
                if ((puzzle[r][c] == "-" || c == 4) && word != "") {
                    if (puzzle[r][c] != "-") {
                        word += puzzle[r][c];
                    }
                    acrossClues.push(word);
                    word = "";
                } else if (puzzle[r][c] != "-") {
                    word += puzzle[r][c]
                }
            }
        }

        let downClues = [];
        for (let c = 0; c < 5; c++) {
            let word = "";
            for (let r = 0; r < 5; r++) {
                if ((puzzle[r][c] == "-" || r == 4) && word != "") {
                    if (puzzle[r][c] != "-") {
                        word += puzzle[r][c];
                    }
                    downClues.push(word);
                    word = "";
                } else if (puzzle[r][c] != "-") {
                    word += puzzle[r][c]
                }
            }
        }

        console.log(acrossClues);
        console.log(downClues);
        
        const clues = document.getElementById("clues-input")

        // across clues
        if (acrossClues.length > 0) {
            clues.innerHTML += "<h4>Across: </h4>"
            acrossClues.forEach((word, i) => {
                clues.innerHTML += String(i + 1) + ". " + word + ": <input type='text' id='" + word + "-clue'></br>";
            });
            clues.innerHTML += "</br>";
        }

        // down clues
        if (downClues.length > 0) {
            clues.innerHTML += "<h4>Down: </h4>"
            downClues.forEach((word, i) => {
                clues.innerHTML += String(i + 1) + ". " + word + ": <input type='text' id='" + word + "-clue'></br>";
            });
            clues.innerHTML += "</br>";
        }

        clues.innerHTML += "<button type='submit'>Save crossword</button>";
    }

    //Call submission handler
    document.getElementById("cw-form").addEventListener("submit", onSubmit);

    //Crossword reader/formatter for backend:
    function readGrid() {
    const grid = [];
    for (let r = 0; r<5; r++) {
        const row = [];
        for (let c = 0; c < 5; c++) {
        const el = document.getElementById(`cross-box-${r}-${c}`);
        const isBlack = el.classList.contains("letter-blacked-out");
        if (isBlack) {
            row.push("#");
        } else {
            const ch = (el.value || "").trim().toUpperCase();
            row.push(ch.length === 1 ? ch : "-");
        }
        }
        grid.push(row);
    }
    return grid;
    }

    async function onSubmit(event) {
    event.preventDefault();
    const msg = document.getElementById("save-msg");
    msg.textContent = "";

    const dateEl = document.getElementById("crossword-date");
    const dateVal = dateEl && dateEl.value ? dateEl.value : null;

    //JSON Obj w/ crossword data:
    const payload = {
        date: dateVal,
        grid: readGrid(),
        origin: "manual",
        article_link: document.getElementById("article-link").value || ""
    };

    try {
        const res = await fetch("/mini/validate", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "X-CSRFToken": CSRF 
            },
            body: JSON.stringify(payload),
        });


        const data = await res.json();
        if (!res.ok || !data.ok) {
        msg.textContent = data.error || "Validation failed.";
        return;
        }

        msg.style.color = "green";
        msg.textContent = "Validation passed. Saving...";

        try {
            const saveRes = await fetch("/mini/save", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "X-CSRFToken": CSRF 
            },
            body: JSON.stringify(payload),
        });


            const saveData = await saveRes.json();
            console.log("saved crossword:", saveData);

            if (!saveRes.ok || !saveData.ok) {
                msg.style.color = "red";
                msg.textContent = saveData.error || "Failed to save crossword.";
                return;
            }

            msg.style.color = "green";
            msg.textContent = "Crossword saved successfully!";
        } catch (e) {
            msg.style.color = "red";
            msg.textContent = "Error during save.";
        }

    } catch (e) {
        msg.textContent = "Error during validation.";
    }
    }

    
</script>

{% endblock %}
